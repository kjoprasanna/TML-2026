// Main function to serve the webapp
function doGet(e) {
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle('Thirumalai Educations')
    .setSandboxMode(HtmlService.SandboxMode.IFRAME);
}

// Function to add student data to Sheet
function addStudent(data) {
  var ss = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID');
  var sheet = ss.getSheetByName('Students');
  var lastRow = sheet.getLastRow();
  var serialNo = lastRow; // Auto serial number starting from 1 (header is row 1)
  
  // Upload image to Drive and get link
  var billLink = '';
  if (data.bill) {
    var folder = DriveApp.getFolderById('YOUR_DRIVE_FOLDER_ID'); // Create a folder in Drive and get its ID
    var blob = Utilities.newBlob(Utilities.base64Decode(data.bill), 'image/jpeg', 'bill.jpg');
    var file = folder.createFile(blob);
    billLink = file.getUrl();
  }
  
  sheet.appendRow([
    serialNo,
    data.date,
    data.name,
    data.department,
    data.college,
    data.remarks,
    data.mobile,
    data.reference,
    data.status,
    billLink
  ]);
  return 'Student added successfully!';
}

// Function to get all students
function getStudents() {
  var ss = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID');
  var sheet = ss.getSheetByName('Students');
  return sheet.getDataRange().getValues();
}

// Functions for dropdown options
function getDepartments() {
  var ss = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID');
  return ss.getSheetByName('Departments').getRange('A:A').getValues().flat().filter(String);
}

function getColleges() {
  var ss = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID');
  return ss.getSheetByName('Colleges').getRange('A:A').getValues().flat().filter(String);
}

function getStatuses() {
  var ss = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID');
  return ss.getSheetByName('Statuses').getRange('A:A').getValues().flat().filter(String);
}

// Function to filter students (for department, college, reference)
function filterStudents(filterType, filterValue) {
  var students = getStudents();
  var filtered = students.filter(row => row[filterType === 'department' ? 3 : filterType === 'college' ? 4 : 7] === filterValue); // Column indices
  return filtered;
}

// Function to edit a student (basic: overwrite row)
function editStudent(serialNo, data) {
  var ss = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID');
  var sheet = ss.getSheetByName('Students');
  var row = parseInt(serialNo) + 1; // Rows start at 1, header is 1
  sheet.getRange(row, 2, 1, 9).setValues([[data.date, data.name, data.department, data.college, data.remarks, data.mobile, data.reference, data.status, data.billLink]]);
  return 'Student updated!';
}

// Include client-side JS in HTML
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}